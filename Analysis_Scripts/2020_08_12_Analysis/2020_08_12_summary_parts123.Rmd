---
title: "Hackathon basic summary"
author: "Gavin Douglas"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    code_folding: hide
    theme: cerulean
    toc: true
    toc_float: true
---

```{r setup, message=FALSE}
library(ape)
library(circlize)
library(ComplexHeatmap)
library(cowplot)
library(ggplot2)
library(knitr)
library(kableExtra)
library(qiime2R)
library(reshape2)
library(pheatmap)
library(tidyverse)

theme_set(theme_classic())

opts_knit$set(root.dir = '/home/jacob/projects/Hackathon/Studies/')
```

```{r define_functions}
read_table_and_check_line_count <- function(filepath, ...) {
  # Function to read in table and to check whether the row count equals the expected line count of the file.
  
  exp_count <- as.numeric(sub(pattern = " .*$", "", system(command = paste("wc -l", filepath, sep=" "), intern = TRUE)))
  
  df <- read.table(filepath, ...)
  
  if(length(grep("^V", colnames(df))) != ncol(df)) {
    exp_count <- exp_count - 1
  }
  
  if(exp_count != nrow(df)) {
    stop(paste("Expected ", as.character(exp_count), " lines, but found ", as.character(nrow(df))))
  } else {
    return(df) 
  }
}


read_hackathon_results <- function(study,
                                   results_folder="Fix_Results_0.1") {
  
  da_tool_filepath <- list()
  da_tool_filepath[["aldex2"]] <- paste(study, results_folder, "Aldex_out/Aldex_res.tsv", sep = "/")
  da_tool_filepath[["ancom"]] <- paste(study, results_folder, "ANCOM_out/Ancom_res.tsv", sep = "/")
  da_tool_filepath[["corncob"]] <- paste(study, results_folder, "Corncob_out/Corncob_results.tsv", sep = "/")
  da_tool_filepath[["deseq2"]] <- paste(study, results_folder, "Deseq2_out/Deseq2_results.tsv", sep = "/")
  da_tool_filepath[["edger"]] <- paste(study, results_folder, "edgeR_out/edgeR_res.tsv", sep = "/")
  da_tool_filepath[["lefse"]] <- paste(study, results_folder, "Lefse_out/Lefse_results.tsv", sep = "/")
  da_tool_filepath[["maaslin2"]] <- paste(study, results_folder, "Maaslin2_out/all_results.tsv", sep = "/")
  da_tool_filepath[["maaslin2rare"]] <- paste(study, results_folder, "Maaslin2_rare_out/all_results.tsv", sep = "/")
  da_tool_filepath[["metagenomeSeq"]] <- paste(study, results_folder, "metagenomeSeq_out/mgSeq_res.tsv", sep = "/")
  da_tool_filepath[["ttestrare"]] <- paste(study, results_folder, "t_test_rare_out/t_test_res.tsv", sep = "/")
  da_tool_filepath[["wilcoxonclr"]] <- paste(study, results_folder, "Wilcoxon_CLR_out/Wil_CLR_results.tsv", sep = "/")
  da_tool_filepath[["wilcoxonrare"]] <- paste(study, results_folder, "Wilcoxon_rare_out/Wil_rare_results.tsv", sep = "/")
  
  adjP_colname <- list()
  adjP_colname[["aldex2"]] <- "wi.eBH"
  adjP_colname[["ancom"]] <- "detected_0.9"
  adjP_colname[["corncob"]] <- "x"
  adjP_colname[["deseq2"]] <- "padj"
  adjP_colname[["edger"]] <- "FDR"
  adjP_colname[["lefse"]] <- "V5"
  adjP_colname[["maaslin2"]] <- "qval"
  adjP_colname[["maaslin2rare"]] <- "qval"
  adjP_colname[["metagenomeSeq"]] <- "adjPvalues"
  adjP_colname[["ttestrare"]] <- "x"
  adjP_colname[["wilcoxonclr"]] <- "x"
  adjP_colname[["wilcoxonrare"]] <- "x"
  
  
  # Read in results files and run sanity check that results files have expected number of lines
  da_tool_results <- list()
  
  missing_tools <- c()
  
  for(da_tool in names(da_tool_filepath)) {
    
    if(! (file.exists(da_tool_filepath[[da_tool]]))) {
       missing_tools <- c(missing_tools, da_tool)
       message(paste("File ", da_tool_filepath[[da_tool]], " not found. Skipping.", sep=""))
       next
    }
    
    if(da_tool %in% c("ancom", "maaslin2", "maaslin2rare")) {
      da_tool_results[[da_tool]] <- read_table_and_check_line_count(da_tool_filepath[[da_tool]], sep="\t", row.names=2, header=TRUE)
    } else if(da_tool == "lefse") {
      da_tool_results[[da_tool]] <- read_table_and_check_line_count(da_tool_filepath[[da_tool]], sep="\t", row.names=1, header=FALSE, stringsAsFactors=FALSE)
      rownames(da_tool_results[[da_tool]]) <- gsub("^f_", "", rownames(da_tool_results[[da_tool]]))
    } else {
      da_tool_results[[da_tool]] <- read_table_and_check_line_count(da_tool_filepath[[da_tool]], sep="\t", row.names=1, header=TRUE)
    }
  }
  
  # Combine corrected P-values into same table.
  all_rows <- c()
  
   for(da_tool in names(adjP_colname)) {
     all_rows <- c(all_rows, rownames(da_tool_results[[da_tool]]))
   }
  all_rows <- all_rows[-which(duplicated(all_rows))]

  adjP_table <- data.frame(matrix(NA, ncol=length(names(da_tool_results)), nrow=length(all_rows)))
  colnames(adjP_table) <- names(da_tool_results)
  rownames(adjP_table) <- all_rows
  
  for(da_tool in colnames(adjP_table)) {
 
    if(da_tool %in% missing_tools) {
       next
    }
    
    if(da_tool == "lefse") {
     
        tmp_lefse <- da_tool_results[[da_tool]][, adjP_colname[[da_tool]]]
        tmp_lefse[which(tmp_lefse == "-")] <- NA
        adjP_table[rownames(da_tool_results[[da_tool]]), da_tool] <- as.numeric(tmp_lefse)

        lefse_tested_asvs <- rownames(da_tool_results$wilcoxonrare)[which(! is.na(da_tool_results$wilcoxonrare))]
        lefse_NA_asvs <- rownames(da_tool_results$lefse)[which(is.na(tmp_lefse))]
  
        adjP_table[lefse_NA_asvs[which(lefse_NA_asvs %in% lefse_tested_asvs)], da_tool] <- 1
        
    } else if(da_tool == "ancom") {
      
      sig_ancom_hits <- which(da_tool_results[[da_tool]][, adjP_colname[[da_tool]]])
      ancom_results <- rep(1, length(da_tool_results[[da_tool]][, adjP_colname[[da_tool]]]))
      ancom_results[sig_ancom_hits] <- 0
      adjP_table[rownames(da_tool_results[[da_tool]]), da_tool] <- ancom_results
    
    } else if(da_tool %in% c("wilcoxonclr", "wilcoxonrare", "ttestrare")) {
      
      # Need to perform FDR-correction on these outputs.
      adjP_table[rownames(da_tool_results[[da_tool]]), da_tool] <- p.adjust(da_tool_results[[da_tool]][, adjP_colname[[da_tool]]], "fdr")
    
    } else {
      adjP_table[rownames(da_tool_results[[da_tool]]), da_tool] <- da_tool_results[[da_tool]][, adjP_colname[[da_tool]]]
    }
  }

  return(list(raw_tables=da_tool_results,
              adjP_table=adjP_table))
  
}
```

# Introduction

I ran basic analyses to run some sanity checks on the results of the processing pipeline and to re-generate the basic results across all of the tested datasets.

# Read in all results

Currently I'm reading all of the results into a single giant list in R, which can then be saved as an RDS file for future reference. You can look at the below code and the `read_hackathon_results` function if you're interested.

Note that the study **ob_zupancic** was excluded, I think because all OTUs were excluded after the filtering step.


```{r read_data, cache=TRUE}
hackathon_study_ids <- c("ArcticFireSoils",
                         "ArcticFreshwaters",
                         "ArcticTransects",
                         "art_scher",
                         "asd_son",
                         "BISCUIT",
                         "Blueberry",
                         "cdi_schubert",
                         "cdi_vincent",
                         "Chemerin",
                         "crc_baxter",
                         "crc_zeller",
                         "edd_singh",
                         "Exercise",
                         "glass_plastic_oberbeckmann",
                         "GWMC_ASIA_NA",
                         "GWMC_HOT_COLD",
                         "hiv_dinh",
                         "hiv_lozupone",
                         "hiv_noguerajulian",
                         "ibd_gevers",
                         "ibd_papa",
                         "Ji_WTP_DS",
                         "MALL",
                         "ob_goodrich",
                         "ob_ross",
                         "ob_turnbaugh",
                         "ob_zhu",
                         ###"ob_zupancic",
                         "Office",
                         "par_scheperjans",
                         "sed_plastic_hoellein",
                         "sed_plastic_rosato",
                         "seston_plastic_mccormick",
                         "sw_plastic_frere",
                         "sw_sed_detender",
                          "t1d_alkanani",
                         "t1d_mejialeon",
                         "wood_plastic_kesy")

filt_results <- lapply(hackathon_study_ids, read_hackathon_results)
names(filt_results) <- hackathon_study_ids


unfilt_results <- lapply(hackathon_study_ids, read_hackathon_results, results_folder = "No_filt_Results")
names(unfilt_results) <- hackathon_study_ids
```

```{r read_test_asvs}
### Get sets of ASVS that were tested for each rarified/unrarified version of dataset.

filt_study_asvs <- list()
filt_study_asvs[["rare"]] <- list()
filt_study_asvs[["nonrare"]] <- list()

for (study in hackathon_study_ids) {

  filt_study_asvs[["nonrare"]][[study]] <- rownames(read.table(paste(study, "/Fix_Results_0.1/fixed_non_rare_tables/", study, "_ASVs_table.tsv", sep=""), header=TRUE, sep="\t", row.names=1, check.names = FALSE))
  
  filt_study_asvs[["rare"]][[study]] <- rownames(read.table(paste(study, "/Fix_Results_0.1/fixed_rare_tables/", study, "_ASVs_table.tsv", sep=""), header=TRUE, sep="\t", row.names=1, check.names = FALSE))
}


unfilt_study_asvs <- list()
unfilt_study_asvs[["rare"]] <- list()
unfilt_study_asvs[["nonrare"]] <- list()

for (study in hackathon_study_ids) {

  unfilt_study_asvs[["nonrare"]][[study]] <- rownames(read.table(paste(study, "/No_filt_Results/fixed_non_rare_tables/", study, "_ASVs_table.tsv", sep=""), header=TRUE, sep="\t", row.names=1, check.names = FALSE))
  
  unfilt_study_asvs[["rare"]][[study]] <- rownames(read.table(paste(study, "/", study, "_ASVs_table_rare.tsv", sep=""), header=TRUE, sep="\t", row.names=1, check.names = FALSE))
}
```


# Number of significant ASVs

```{r parse_count_table_filt}
sig_counts <- data.frame(matrix(NA,
                                nrow=length(names(filt_results)),
                                ncol=ncol(filt_results[[1]]$adjP_table) + 1))
rownames(sig_counts) <- names(filt_results)
colnames(sig_counts) <- c("dataset", colnames(filt_results[[1]]$adjP_table))
sig_counts$dataset <- rownames(sig_counts)

filt_sig_counts <- sig_counts
filt_sig_percent <- sig_counts

unfilt_sig_counts <- sig_counts
unfilt_sig_percent <- sig_counts

for(study in rownames(filt_sig_counts)) {
  for(tool_name in colnames(filt_sig_counts)) {
    
    if(tool_name == "dataset") { next }

    if(! tool_name %in% colnames(filt_results[[study]]$adjP_table)) {
      filt_sig_counts[study, tool_name] <- NA
      filt_sig_percent[study, tool_name] <- NA
      next
    }
    
    filt_sig_counts[study, tool_name] <- length(which(filt_results[[study]]$adjP_table[, tool_name] < 0.05))
    
    # For rarified pipelines get total # ASVs from wilcoxonrare and for non-rarified get it from wilcoxonclr table.
    if(tool_name %in% c("lefse", "maaslin2rare", "ttestrare", "wilcoxonrare")) {
      filt_sig_percent[study, tool_name] <- (length(which(filt_results[[study]]$adjP_table[, tool_name] < 0.05)) / length(filt_study_asvs[["rare"]][[study]])) * 100
    } else {
      filt_sig_percent[study, tool_name] <- (length(which(filt_results[[study]]$adjP_table[, tool_name] < 0.05)) / length(filt_study_asvs[["nonrare"]][[study]])) * 100
    }
  }
}


for(study in rownames(unfilt_sig_counts)) {
  for(tool_name in colnames(unfilt_sig_counts)) {
    
    if(tool_name == "dataset") { next }

    if(! tool_name %in% colnames(unfilt_results[[study]]$adjP_table)) {
      unfilt_sig_counts[study, tool_name] <- NA
      unfilt_sig_percent[study, tool_name] <- NA
      next
    }
    
    unfilt_sig_counts[study, tool_name] <- length(which(unfilt_results[[study]]$adjP_table[, tool_name] < 0.05))
    
    # For rarified pipelines get total # ASVs from wilcoxonrare and for non-rarified get it from wilcoxonclr table.
    if(tool_name %in% c("lefse", "maaslin2rare", "ttestrare", "wilcoxonrare")) {
      unfilt_sig_percent[study, tool_name] <- (length(which(unfilt_results[[study]]$adjP_table[, tool_name] < 0.05)) / length(unfilt_study_asvs[["rare"]][[study]])) * 100
    } else {
      unfilt_sig_percent[study, tool_name] <- (length(which(unfilt_results[[study]]$adjP_table[, tool_name] < 0.05)) / length(unfilt_study_asvs[["nonrare"]][[study]])) * 100
    }
  }
}
```

## Raw count table {.tabset}

The below tables show the total number of significant ASVs identified by each tool for each dataset. The grey column headers indicate that the table was rarified before running the tool.

### Filtered data

```{r plot_count_table_filt}
filt_sig_counts %>%
kable(align = 'c', row.names = FALSE, digits=2) %>%
  kable_styling() %>%
  # Colour column header light grey if corresponds to rarified data
  column_spec(column = which(colnames(filt_sig_counts) %in% c("lefse", "maaslin2rare", "ttestrare", "wilcoxonrare")),
              background = "grey", include_thead = TRUE, color="white") %>%
  column_spec(column = which(! colnames(filt_sig_counts) %in% c("lefse", "maaslin2rare", "ttestrare", "wilcoxonrare")),
              background = "cornflowerblue", include_thead = TRUE, color="black") %>%
  row_spec(row = 1:nrow(filt_sig_counts),
           bold = TRUE,
           color="black",
           background = "white") %>% 
   scroll_box(width = "1000px", height = "400px")
```

### Unfiltered data
```{r plot_count_table_unfilt}
unfilt_sig_counts %>%
kable(align = 'c', row.names = FALSE, digits=2) %>%
  kable_styling() %>%
  # Colour column header light grey if corresponds to rarified data
  column_spec(column = which(colnames(unfilt_sig_counts) %in% c("lefse", "maaslin2rare", "ttestrare", "wilcoxonrare")),
              background = "grey", include_thead = TRUE, color="white") %>%
  column_spec(column = which(! colnames(unfilt_sig_counts) %in% c("lefse", "maaslin2rare", "ttestrare", "wilcoxonrare")),
              background = "cornflowerblue", include_thead = TRUE, color="black") %>%
  row_spec(row = 1:nrow(unfilt_sig_counts),
           bold = TRUE,
           color="black",
           background = "white") %>% 
   scroll_box(width = "1000px", height = "400px")
```

## Percentage tables {.tabset}

And the same tables as above, but representing the percent of the total number of ASVs that are significant per dataset.

### Filtered data

```{r plot_percent_table_filt}
filt_sig_percent %>%
kable(align = 'c', row.names = FALSE, digits=2) %>%
  kable_styling() %>%
  # Colour column header light grey if corresponds to rarified data
  column_spec(column = which(colnames(filt_sig_percent) %in% c("lefse", "maaslin2rare", "ttestrare", "wilcoxonrare")),
              background = "grey", include_thead = TRUE, color="white") %>%
  column_spec(column = which(! colnames(filt_sig_percent) %in% c("lefse", "maaslin2rare", "ttestrare", "wilcoxonrare")),
              background = "cornflowerblue", include_thead = TRUE, color="black") %>%
  row_spec(row = 1:nrow(filt_sig_percent),
           bold = TRUE,
           color="black",
           background = "white") %>% 
   scroll_box(width = "1000px", height = "400px")
```

### Unfiltered data

```{r plot_percent_table_unfilt}
unfilt_sig_percent %>%
kable(align = 'c', row.names = FALSE, digits=2) %>%
  kable_styling() %>%
  # Colour column header light grey if corresponds to rarified data
  column_spec(column = which(colnames(unfilt_sig_percent) %in% c("lefse", "maaslin2rare", "ttestrare", "wilcoxonrare")),
              background = "grey", include_thead = TRUE, color="white") %>%
  column_spec(column = which(! colnames(unfilt_sig_percent) %in% c("lefse", "maaslin2rare", "ttestrare", "wilcoxonrare")),
              background = "cornflowerblue", include_thead = TRUE, color="black") %>%
  row_spec(row = 1:nrow(unfilt_sig_percent),
           bold = TRUE,
           color="black",
           background = "white") %>% 
   scroll_box(width = "1000px", height = "400px")
```


## Mean percent across all datasets

Across all filtered datasets:

```{r print_mean_per_filt}
print(sort(colSums(filt_sig_percent[, -1], na.rm = TRUE) / (colSums(! is.na(filt_sig_percent[, -1])))))
```

Across all unfiltered datasets:

```{r print_mean_per_unfilt}
print(sort(colSums(unfilt_sig_percent[, -1], na.rm = TRUE) / (colSums(! is.na(unfilt_sig_percent[, -1])))))
```


## Count table heatmaps {.tabset}

The above tables are somewhat useful, but I think for the manuscript we might want to show the data as a heatmap of the data (colours indicate standardized values based on scaling and centering % sig. hits by dataset), with the counts included too as below. Clustering was complete hierarchical clustering based on euclidean distances of the standardized data.


### Filtered dataset

```{r count_heatmap_filt, fig.height=6, fig.width=15}

filt_sig_percent_scaled <- data.frame(scale(t(filt_sig_percent[, -1]), center = TRUE, scale = TRUE))

hackathon_metadata <- read.table("/home/gavin/gavin_backup/misc/hackathon/2020_06_18_Datasets_Hackathon.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE, quote="")
rownames(hackathon_metadata) <- hackathon_metadata$Dataset.Name

hackathon_metadata$log_N <- log(hackathon_metadata$Sample.Size)

aitchison_adonis <- readRDS(file = "/home/gavin/gavin_backup/misc/hackathon/aitchison_adonis_no_ob_zupancic.rds")

hackathon_metadata$R.squared <- NA

for(dataset in names(aitchison_adonis)) {
  hackathon_metadata[dataset, "R.squared"] <- aitchison_adonis[[dataset]]$R2[1]
}

hackathon_metadata$log_R.squared <- log(hackathon_metadata$R.squared)

pheatmap(filt_sig_percent_scaled,
         clustering_method = "complete",
         legend=TRUE,
         display_numbers=t(filt_sig_counts[, -1]),
         annotation_col=hackathon_metadata[, c("log_N", "log_R.squared"), drop=FALSE])
```

### Unfiltered dataset

```{r count_heatmap_unfilt, fig.height=6, fig.width=15}

unfilt_sig_percent_scaled <- data.frame(scale(t(unfilt_sig_percent[, -1]), center = TRUE, scale = TRUE))

hackathon_metadata <- read.table("/home/gavin/gavin_backup/misc/hackathon/2020_06_18_Datasets_Hackathon.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE, quote="")
rownames(hackathon_metadata) <- hackathon_metadata$Dataset.Name

hackathon_metadata$log_N <- log(hackathon_metadata$Sample.Size)

aitchison_adonis <- readRDS(file = "/home/gavin/gavin_backup/misc/hackathon/aitchison_adonis_no_ob_zupancic.rds")

hackathon_metadata$R.squared <- NA

for(dataset in names(aitchison_adonis)) {
  hackathon_metadata[dataset, "R.squared"] <- aitchison_adonis[[dataset]]$R2[1]
}

hackathon_metadata$log_R.squared <- log(hackathon_metadata$R.squared)

pheatmap(unfilt_sig_percent_scaled,
         clustering_method = "complete",
         legend=TRUE,
         display_numbers=t(unfilt_sig_counts[, -1]),
         annotation_col=hackathon_metadata[, c("log_N", "log_R.squared"), drop=FALSE])
```



## Differences with previous result files {.tabset}

## Original counts

This was Table 1 in Jocelyn's report:
![](/home/gavin/gavin_backup/misc/hackathon/original_jocelyn_sig_count_table.png)

## Filtered counts (subset)
```{r recreate_orig_table_filt}

origtools <- c("corncob", "aldex2", "maaslin2", "ancom", "lefse", "deseq2", "wilcoxonclr", "wilcoxonrare")
origstudies <- c("Chemerin", "BISCUIT", "Blueberry", "MALL", "Exercise")

pheatmap(scale(data.frame(t(filt_sig_counts[, -1]))[origtools, origstudies], center = TRUE, scale=TRUE),
         cluster_rows = FALSE,
         cluster_cols = FALSE,
         legend=TRUE,
         display_numbers=data.frame(t(filt_sig_counts[, -1]))[origtools, origstudies])
```


### Unfiltered counts (subset)
```{r recreate_orig_table_unfilt}

origtools <- c("corncob", "aldex2", "maaslin2", "ancom", "lefse", "deseq2", "wilcoxonclr", "wilcoxonrare")
origstudies <- c("Chemerin", "BISCUIT", "Blueberry", "MALL", "Exercise")

pheatmap(scale(data.frame(t(unfilt_sig_counts[, -1]))[origtools, origstudies], center = TRUE, scale=TRUE),
         cluster_rows = FALSE,
         cluster_cols = FALSE,
         legend=TRUE,
         display_numbers=data.frame(t(unfilt_sig_counts[, -1]))[origtools, origstudies])
```



# Summarizing variation in # sig. hits

## CV vs mean {.tabset}

Because we now have many more validation datasets we can do some actual statistics! I thought the below analysis comparing the mean percentage of significant ASVs and the coefficient of variation (cv) across datasets for that tool might be a sensible way to compare how the tools differ. I'm not so sure it's telling us anything useful, but worth considering what analysis could be done along these lines!

CV = (sd / mean) * 100

### Filtered data

```{r tool_metrics_filt}
tool_percent_means <- colSums(filt_sig_percent[, -1]) / nrow(filt_sig_percent)
tool_perecent_sd <- apply(filt_sig_percent[, -1], 2, sd)
tool_perecent_cv <- (tool_perecent_sd / tool_percent_means) * 100

plot(tool_percent_means, tool_perecent_cv, col="white", xlim=c(0, 40), ylim=c(0, 250))
text(tool_percent_means, tool_perecent_cv, names(tool_percent_means))
```


### Unfiltered data

```{r tool_metrics_unfilt}
tool_percent_means <- colSums(unfilt_sig_percent[, -1]) / nrow(unfilt_sig_percent)
tool_perecent_sd <- apply(unfilt_sig_percent[, -1], 2, sd)
tool_perecent_cv <- (tool_perecent_sd / tool_percent_means) * 100

plot(tool_percent_means, tool_perecent_cv, col="white", xlim=c(0, 40), ylim=c(0, 250))
text(tool_percent_means, tool_perecent_cv, names(tool_percent_means))
```

## Spearman correlation w N and R-squared {.tabset}

### Filtered data

```{r meta_cor_filt}
tool_names <- colnames(filt_sig_percent)
tool_names <- tool_names[-which(tool_names == "dataset")]
cor_df <- data.frame(matrix(NA, nrow=length(tool_names), ncol=4))
colnames(cor_df) <- c("Tool", "Sample.Size", "minor_class_percent", "R.squared")
rownames(cor_df) <- tool_names

cor_df$Tool <- rownames(cor_df)

hackathon_metadata$minor_class_percent <- (hackathon_metadata$Minor.Group.Size / hackathon_metadata$Sample.Size) * 100

for(tool_name in tool_names) {
  
  for(comparison in colnames(cor_df)[-1]) {
    cor_df[tool_name, comparison] <- round(cor.test(hackathon_metadata[rownames(filt_sig_percent), comparison],
                                                    filt_sig_percent[, tool_name])$estimate ** 2, 3)
  }
}


cor_df %>%
  mutate_if(is.numeric, function(x) {
    cell_spec(x, bold = TRUE, background="light grey",
              color = spec_color(x, option="D", end=max(x) * 0.9))
  }) %>%
kable(escape=FALSE, align = 'c', digits=2, format='html') %>%
  kable_styling(c("striped", "condensed"), full_width = FALSE) %>%
   scroll_box(width = "1000px", height = "400px")
```

### Unfiltered data

```{r meta_cor_unfilt}
tool_names <- colnames(unfilt_sig_percent)
tool_names <- tool_names[-which(tool_names == "dataset")]
cor_df <- data.frame(matrix(NA, nrow=length(tool_names), ncol=4))
colnames(cor_df) <- c("Tool", "Sample.Size", "minor_class_percent", "R.squared")
rownames(cor_df) <- tool_names

cor_df$Tool <- rownames(cor_df)

hackathon_metadata$minor_class_percent <- (hackathon_metadata$Minor.Group.Size / hackathon_metadata$Sample.Size) * 100

for(tool_name in tool_names) {
  
  for(comparison in colnames(cor_df)[-1]) {
    cor_df[tool_name, comparison] <- round(cor.test(hackathon_metadata[rownames(unfilt_sig_percent), comparison],
                                                    unfilt_sig_percent[, tool_name])$estimate ** 2, 3)
  }
}


cor_df %>%
  mutate_if(is.numeric, function(x) {
    cell_spec(x, bold = TRUE, background="light grey",
              color = spec_color(x, option="D", end=max(x) * 0.9))
  }) %>%
kable(escape=FALSE, align = 'c', digits=2, format='html') %>%
  kable_styling(c("striped", "condensed"), full_width = FALSE) %>%
   scroll_box(width = "1000px", height = "400px")
```

# Heatmap of overlapping sig. hits {.tabset}

Below are the heatmaps of overlapping significant ASVs per dataset. Note that ASVs are restricted only to those tested in the non-rarified tests. Blue=significant, black=non-significant, grey=NA (which I think is because the tools have an internal filtering step).

Clustering was based on hierarchical clustering with the complete method based on binary distances.

```{r define_heatmap_and_combined_list}
heatmaps_filt <- list()
all_P_tables_filt <- list()

heatmaps_unfilt <- list()
all_P_tables_unfilt <- list()
```


## Filtered data {.tabset}


### ArcticFireSoils
```{r ArcticFireSoils_heatmap_filt, cache=TRUE}
     ArcticFireSoils_P_filt <- filt_results[["ArcticFireSoils"]]$adjP_table
     ArcticFireSoils_P_filt[ArcticFireSoils_P_filt >= 0.05] <- 1
     ArcticFireSoils_P_filt[ArcticFireSoils_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(ArcticFireSoils_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         ArcticFireSoils_P_filt <- ArcticFireSoils_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["ArcticFireSoils"]] <- ArcticFireSoils_P_filt

     table2plot <- ArcticFireSoils_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["ArcticFireSoils"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["ArcticFireSoils"]]
```


### ArcticFreshwaters
```{r ArcticFreshwaters_heatmap_filt, cache=TRUE}
     ArcticFreshwaters_P_filt <- filt_results[["ArcticFreshwaters"]]$adjP_table
     ArcticFreshwaters_P_filt[ArcticFreshwaters_P_filt >= 0.05] <- 1
     ArcticFreshwaters_P_filt[ArcticFreshwaters_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(ArcticFreshwaters_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         ArcticFreshwaters_P_filt <- ArcticFreshwaters_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["ArcticFreshwaters"]] <- ArcticFreshwaters_P_filt

     table2plot <- ArcticFreshwaters_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["ArcticFreshwaters"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["ArcticFreshwaters"]]
```


### ArcticTransects
```{r ArcticTransects_heatmap_filt, cache=TRUE}
     ArcticTransects_P_filt <- filt_results[["ArcticTransects"]]$adjP_table
     ArcticTransects_P_filt[ArcticTransects_P_filt >= 0.05] <- 1
     ArcticTransects_P_filt[ArcticTransects_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(ArcticTransects_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         ArcticTransects_P_filt <- ArcticTransects_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["ArcticTransects"]] <- ArcticTransects_P_filt

     table2plot <- ArcticTransects_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["ArcticTransects"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["ArcticTransects"]]
```


### art_scher
```{r art_scher_heatmap_filt, cache=TRUE}
     art_scher_P_filt <- filt_results[["art_scher"]]$adjP_table
     art_scher_P_filt[art_scher_P_filt >= 0.05] <- 1
     art_scher_P_filt[art_scher_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(art_scher_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         art_scher_P_filt <- art_scher_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["art_scher"]] <- art_scher_P_filt

     table2plot <- art_scher_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["art_scher"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["art_scher"]]
```


### asd_son
```{r asd_son_heatmap_filt, cache=TRUE}
     asd_son_P_filt <- filt_results[["asd_son"]]$adjP_table
     asd_son_P_filt[asd_son_P_filt >= 0.05] <- 1
     asd_son_P_filt[asd_son_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(asd_son_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         asd_son_P_filt <- asd_son_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["asd_son"]] <- asd_son_P_filt

     table2plot <- asd_son_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["asd_son"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["asd_son"]]
```


### BISCUIT
```{r BISCUIT_heatmap_filt, cache=TRUE}
     BISCUIT_P_filt <- filt_results[["BISCUIT"]]$adjP_table
     BISCUIT_P_filt[BISCUIT_P_filt >= 0.05] <- 1
     BISCUIT_P_filt[BISCUIT_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(BISCUIT_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         BISCUIT_P_filt <- BISCUIT_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["BISCUIT"]] <- BISCUIT_P_filt

     table2plot <- BISCUIT_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["BISCUIT"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["BISCUIT"]]
```


### Blueberry
```{r Blueberry_heatmap_filt, cache=TRUE}
     Blueberry_P_filt <- filt_results[["Blueberry"]]$adjP_table
     Blueberry_P_filt[Blueberry_P_filt >= 0.05] <- 1
     Blueberry_P_filt[Blueberry_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(Blueberry_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         Blueberry_P_filt <- Blueberry_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["Blueberry"]] <- Blueberry_P_filt

     table2plot <- Blueberry_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["Blueberry"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["Blueberry"]]
```


### cdi_schubert
```{r cdi_schubert_heatmap_filt, cache=TRUE}
     cdi_schubert_P_filt <- filt_results[["cdi_schubert"]]$adjP_table
     cdi_schubert_P_filt[cdi_schubert_P_filt >= 0.05] <- 1
     cdi_schubert_P_filt[cdi_schubert_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(cdi_schubert_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         cdi_schubert_P_filt <- cdi_schubert_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["cdi_schubert"]] <- cdi_schubert_P_filt

     table2plot <- cdi_schubert_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["cdi_schubert"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["cdi_schubert"]]
```


### cdi_vincent
```{r cdi_vincent_heatmap_filt, cache=TRUE}
     cdi_vincent_P_filt <- filt_results[["cdi_vincent"]]$adjP_table
     cdi_vincent_P_filt[cdi_vincent_P_filt >= 0.05] <- 1
     cdi_vincent_P_filt[cdi_vincent_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(cdi_vincent_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         cdi_vincent_P_filt <- cdi_vincent_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["cdi_vincent"]] <- cdi_vincent_P_filt

     table2plot <- cdi_vincent_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["cdi_vincent"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["cdi_vincent"]]
```


### Chemerin
```{r Chemerin_heatmap_filt, cache=TRUE}
     Chemerin_P_filt <- filt_results[["Chemerin"]]$adjP_table
     Chemerin_P_filt[Chemerin_P_filt >= 0.05] <- 1
     Chemerin_P_filt[Chemerin_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(Chemerin_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         Chemerin_P_filt <- Chemerin_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["Chemerin"]] <- Chemerin_P_filt

     table2plot <- Chemerin_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["Chemerin"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["Chemerin"]]
```


### crc_baxter
```{r crc_baxter_heatmap_filt, cache=TRUE}
     crc_baxter_P_filt <- filt_results[["crc_baxter"]]$adjP_table
     crc_baxter_P_filt[crc_baxter_P_filt >= 0.05] <- 1
     crc_baxter_P_filt[crc_baxter_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(crc_baxter_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         crc_baxter_P_filt <- crc_baxter_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["crc_baxter"]] <- crc_baxter_P_filt

     table2plot <- crc_baxter_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["crc_baxter"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["crc_baxter"]]
```


### crc_zeller
```{r crc_zeller_heatmap_filt, cache=TRUE}
     crc_zeller_P_filt <- filt_results[["crc_zeller"]]$adjP_table
     crc_zeller_P_filt[crc_zeller_P_filt >= 0.05] <- 1
     crc_zeller_P_filt[crc_zeller_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(crc_zeller_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         crc_zeller_P_filt <- crc_zeller_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["crc_zeller"]] <- crc_zeller_P_filt

     table2plot <- crc_zeller_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["crc_zeller"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["crc_zeller"]]
```


### edd_singh
```{r edd_singh_heatmap_filt, cache=TRUE}
     edd_singh_P_filt <- filt_results[["edd_singh"]]$adjP_table
     edd_singh_P_filt[edd_singh_P_filt >= 0.05] <- 1
     edd_singh_P_filt[edd_singh_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(edd_singh_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         edd_singh_P_filt <- edd_singh_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["edd_singh"]] <- edd_singh_P_filt

     table2plot <- edd_singh_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["edd_singh"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["edd_singh"]]
```


### Exercise
```{r Exercise_heatmap_filt, cache=TRUE}
     Exercise_P_filt <- filt_results[["Exercise"]]$adjP_table
     Exercise_P_filt[Exercise_P_filt >= 0.05] <- 1
     Exercise_P_filt[Exercise_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(Exercise_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         Exercise_P_filt <- Exercise_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["Exercise"]] <- Exercise_P_filt

     table2plot <- Exercise_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["Exercise"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["Exercise"]]
```


### glass_plastic_oberbeckmann
```{r glass_plastic_oberbeckmann_heatmap_filt, cache=TRUE}
     glass_plastic_oberbeckmann_P_filt <- filt_results[["glass_plastic_oberbeckmann"]]$adjP_table
     glass_plastic_oberbeckmann_P_filt[glass_plastic_oberbeckmann_P_filt >= 0.05] <- 1
     glass_plastic_oberbeckmann_P_filt[glass_plastic_oberbeckmann_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(glass_plastic_oberbeckmann_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         glass_plastic_oberbeckmann_P_filt <- glass_plastic_oberbeckmann_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["glass_plastic_oberbeckmann"]] <- glass_plastic_oberbeckmann_P_filt

     table2plot <- glass_plastic_oberbeckmann_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["glass_plastic_oberbeckmann"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["glass_plastic_oberbeckmann"]]
```


### GWMC_ASIA_NA
```{r GWMC_ASIA_NA_heatmap_filt, cache=TRUE}
     GWMC_ASIA_NA_P_filt <- filt_results[["GWMC_ASIA_NA"]]$adjP_table
     GWMC_ASIA_NA_P_filt[GWMC_ASIA_NA_P_filt >= 0.05] <- 1
     GWMC_ASIA_NA_P_filt[GWMC_ASIA_NA_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(GWMC_ASIA_NA_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         GWMC_ASIA_NA_P_filt <- GWMC_ASIA_NA_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["GWMC_ASIA_NA"]] <- GWMC_ASIA_NA_P_filt

     table2plot <- GWMC_ASIA_NA_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["GWMC_ASIA_NA"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["GWMC_ASIA_NA"]]
```


### GWMC_HOT_COLD
```{r GWMC_HOT_COLD_heatmap_filt, cache=TRUE}
     GWMC_HOT_COLD_P_filt <- filt_results[["GWMC_HOT_COLD"]]$adjP_table
     GWMC_HOT_COLD_P_filt[GWMC_HOT_COLD_P_filt >= 0.05] <- 1
     GWMC_HOT_COLD_P_filt[GWMC_HOT_COLD_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(GWMC_HOT_COLD_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         GWMC_HOT_COLD_P_filt <- GWMC_HOT_COLD_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["GWMC_HOT_COLD"]] <- GWMC_HOT_COLD_P_filt

     table2plot <- GWMC_HOT_COLD_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["GWMC_HOT_COLD"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["GWMC_HOT_COLD"]]
```


### hiv_dinh
```{r hiv_dinh_heatmap_filt, cache=TRUE}
     hiv_dinh_P_filt <- filt_results[["hiv_dinh"]]$adjP_table
     hiv_dinh_P_filt[hiv_dinh_P_filt >= 0.05] <- 1
     hiv_dinh_P_filt[hiv_dinh_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(hiv_dinh_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         hiv_dinh_P_filt <- hiv_dinh_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["hiv_dinh"]] <- hiv_dinh_P_filt

     table2plot <- hiv_dinh_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["hiv_dinh"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["hiv_dinh"]]
```


### hiv_lozupone
```{r hiv_lozupone_heatmap_filt, cache=TRUE}
     hiv_lozupone_P_filt <- filt_results[["hiv_lozupone"]]$adjP_table
     hiv_lozupone_P_filt[hiv_lozupone_P_filt >= 0.05] <- 1
     hiv_lozupone_P_filt[hiv_lozupone_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(hiv_lozupone_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         hiv_lozupone_P_filt <- hiv_lozupone_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["hiv_lozupone"]] <- hiv_lozupone_P_filt

     table2plot <- hiv_lozupone_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["hiv_lozupone"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["hiv_lozupone"]]
```


### hiv_noguerajulian
```{r hiv_noguerajulian_heatmap_filt, cache=TRUE}
     hiv_noguerajulian_P_filt <- filt_results[["hiv_noguerajulian"]]$adjP_table
     hiv_noguerajulian_P_filt[hiv_noguerajulian_P_filt >= 0.05] <- 1
     hiv_noguerajulian_P_filt[hiv_noguerajulian_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(hiv_noguerajulian_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         hiv_noguerajulian_P_filt <- hiv_noguerajulian_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["hiv_noguerajulian"]] <- hiv_noguerajulian_P_filt

     table2plot <- hiv_noguerajulian_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["hiv_noguerajulian"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["hiv_noguerajulian"]]
```


### ibd_gevers
```{r ibd_gevers_heatmap_filt, cache=TRUE}
     ibd_gevers_P_filt <- filt_results[["ibd_gevers"]]$adjP_table
     ibd_gevers_P_filt[ibd_gevers_P_filt >= 0.05] <- 1
     ibd_gevers_P_filt[ibd_gevers_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(ibd_gevers_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         ibd_gevers_P_filt <- ibd_gevers_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["ibd_gevers"]] <- ibd_gevers_P_filt

     table2plot <- ibd_gevers_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["ibd_gevers"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["ibd_gevers"]]
```


### ibd_papa
```{r ibd_papa_heatmap_filt, cache=TRUE}
     ibd_papa_P_filt <- filt_results[["ibd_papa"]]$adjP_table
     ibd_papa_P_filt[ibd_papa_P_filt >= 0.05] <- 1
     ibd_papa_P_filt[ibd_papa_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(ibd_papa_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         ibd_papa_P_filt <- ibd_papa_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["ibd_papa"]] <- ibd_papa_P_filt

     table2plot <- ibd_papa_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["ibd_papa"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["ibd_papa"]]
```


### Ji_WTP_DS
```{r Ji_WTP_DS_heatmap_filt, cache=TRUE}
     Ji_WTP_DS_P_filt <- filt_results[["Ji_WTP_DS"]]$adjP_table
     Ji_WTP_DS_P_filt[Ji_WTP_DS_P_filt >= 0.05] <- 1
     Ji_WTP_DS_P_filt[Ji_WTP_DS_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(Ji_WTP_DS_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         Ji_WTP_DS_P_filt <- Ji_WTP_DS_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["Ji_WTP_DS"]] <- Ji_WTP_DS_P_filt

     table2plot <- Ji_WTP_DS_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["Ji_WTP_DS"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["Ji_WTP_DS"]]
```


### MALL
```{r MALL_heatmap_filt, cache=TRUE}
     MALL_P_filt <- filt_results[["MALL"]]$adjP_table
     MALL_P_filt[MALL_P_filt >= 0.05] <- 1
     MALL_P_filt[MALL_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(MALL_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         MALL_P_filt <- MALL_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["MALL"]] <- MALL_P_filt

     table2plot <- MALL_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["MALL"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["MALL"]]
```


### ob_goodrich
```{r ob_goodrich_heatmap_filt, cache=TRUE}
     ob_goodrich_P_filt <- filt_results[["ob_goodrich"]]$adjP_table
     ob_goodrich_P_filt[ob_goodrich_P_filt >= 0.05] <- 1
     ob_goodrich_P_filt[ob_goodrich_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(ob_goodrich_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         ob_goodrich_P_filt <- ob_goodrich_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["ob_goodrich"]] <- ob_goodrich_P_filt

     table2plot <- ob_goodrich_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["ob_goodrich"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["ob_goodrich"]]
```


### ob_ross
```{r ob_ross_heatmap_filt, cache=TRUE}
     ob_ross_P_filt <- filt_results[["ob_ross"]]$adjP_table
     ob_ross_P_filt[ob_ross_P_filt >= 0.05] <- 1
     ob_ross_P_filt[ob_ross_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(ob_ross_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         ob_ross_P_filt <- ob_ross_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["ob_ross"]] <- ob_ross_P_filt

     table2plot <- ob_ross_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["ob_ross"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["ob_ross"]]
```


### ob_turnbaugh
```{r ob_turnbaugh_heatmap_filt, cache=TRUE}
     ob_turnbaugh_P_filt <- filt_results[["ob_turnbaugh"]]$adjP_table
     ob_turnbaugh_P_filt[ob_turnbaugh_P_filt >= 0.05] <- 1
     ob_turnbaugh_P_filt[ob_turnbaugh_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(ob_turnbaugh_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         ob_turnbaugh_P_filt <- ob_turnbaugh_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["ob_turnbaugh"]] <- ob_turnbaugh_P_filt

     table2plot <- ob_turnbaugh_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["ob_turnbaugh"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["ob_turnbaugh"]]
```


### ob_zhu
```{r ob_zhu_heatmap_filt, cache=TRUE}
     ob_zhu_P_filt <- filt_results[["ob_zhu"]]$adjP_table
     ob_zhu_P_filt[ob_zhu_P_filt >= 0.05] <- 1
     ob_zhu_P_filt[ob_zhu_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(ob_zhu_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         ob_zhu_P_filt <- ob_zhu_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["ob_zhu"]] <- ob_zhu_P_filt

     table2plot <- ob_zhu_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["ob_zhu"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["ob_zhu"]]
```


### Office
```{r Office_heatmap_filt, cache=TRUE}
     Office_P_filt <- filt_results[["Office"]]$adjP_table
     Office_P_filt[Office_P_filt >= 0.05] <- 1
     Office_P_filt[Office_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(Office_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         Office_P_filt <- Office_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["Office"]] <- Office_P_filt

     table2plot <- Office_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["Office"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["Office"]]
```


### par_scheperjans
```{r par_scheperjans_heatmap_filt, cache=TRUE}
     par_scheperjans_P_filt <- filt_results[["par_scheperjans"]]$adjP_table
     par_scheperjans_P_filt[par_scheperjans_P_filt >= 0.05] <- 1
     par_scheperjans_P_filt[par_scheperjans_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(par_scheperjans_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         par_scheperjans_P_filt <- par_scheperjans_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["par_scheperjans"]] <- par_scheperjans_P_filt

     table2plot <- par_scheperjans_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["par_scheperjans"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["par_scheperjans"]]
```


### sed_plastic_hoellein
```{r sed_plastic_hoellein_heatmap_filt, cache=TRUE}
     sed_plastic_hoellein_P_filt <- filt_results[["sed_plastic_hoellein"]]$adjP_table
     sed_plastic_hoellein_P_filt[sed_plastic_hoellein_P_filt >= 0.05] <- 1
     sed_plastic_hoellein_P_filt[sed_plastic_hoellein_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(sed_plastic_hoellein_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         sed_plastic_hoellein_P_filt <- sed_plastic_hoellein_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["sed_plastic_hoellein"]] <- sed_plastic_hoellein_P_filt

     table2plot <- sed_plastic_hoellein_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["sed_plastic_hoellein"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["sed_plastic_hoellein"]]
```


### sed_plastic_rosato
```{r sed_plastic_rosato_heatmap_filt, cache=TRUE}
     sed_plastic_rosato_P_filt <- filt_results[["sed_plastic_rosato"]]$adjP_table
     sed_plastic_rosato_P_filt[sed_plastic_rosato_P_filt >= 0.05] <- 1
     sed_plastic_rosato_P_filt[sed_plastic_rosato_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(sed_plastic_rosato_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         sed_plastic_rosato_P_filt <- sed_plastic_rosato_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["sed_plastic_rosato"]] <- sed_plastic_rosato_P_filt

     table2plot <- sed_plastic_rosato_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["sed_plastic_rosato"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["sed_plastic_rosato"]]
```


### seston_plastic_mccormick
```{r seston_plastic_mccormick_heatmap_filt, cache=TRUE}
     seston_plastic_mccormick_P_filt <- filt_results[["seston_plastic_mccormick"]]$adjP_table
     seston_plastic_mccormick_P_filt[seston_plastic_mccormick_P_filt >= 0.05] <- 1
     seston_plastic_mccormick_P_filt[seston_plastic_mccormick_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(seston_plastic_mccormick_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         seston_plastic_mccormick_P_filt <- seston_plastic_mccormick_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["seston_plastic_mccormick"]] <- seston_plastic_mccormick_P_filt

     table2plot <- seston_plastic_mccormick_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["seston_plastic_mccormick"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["seston_plastic_mccormick"]]
```


### sw_plastic_frere
```{r sw_plastic_frere_heatmap_filt, cache=TRUE}
     sw_plastic_frere_P_filt <- filt_results[["sw_plastic_frere"]]$adjP_table
     sw_plastic_frere_P_filt[sw_plastic_frere_P_filt >= 0.05] <- 1
     sw_plastic_frere_P_filt[sw_plastic_frere_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(sw_plastic_frere_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         sw_plastic_frere_P_filt <- sw_plastic_frere_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["sw_plastic_frere"]] <- sw_plastic_frere_P_filt

     table2plot <- sw_plastic_frere_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["sw_plastic_frere"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["sw_plastic_frere"]]
```


### sw_sed_detender
```{r sw_sed_detender_heatmap_filt, cache=TRUE}
     sw_sed_detender_P_filt <- filt_results[["sw_sed_detender"]]$adjP_table
     sw_sed_detender_P_filt[sw_sed_detender_P_filt >= 0.05] <- 1
     sw_sed_detender_P_filt[sw_sed_detender_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(sw_sed_detender_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         sw_sed_detender_P_filt <- sw_sed_detender_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["sw_sed_detender"]] <- sw_sed_detender_P_filt

     table2plot <- sw_sed_detender_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["sw_sed_detender"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["sw_sed_detender"]]
```


### t1d_alkanani
```{r t1d_alkanani_heatmap_filt, cache=TRUE}
     t1d_alkanani_P_filt <- filt_results[["t1d_alkanani"]]$adjP_table
     t1d_alkanani_P_filt[t1d_alkanani_P_filt >= 0.05] <- 1
     t1d_alkanani_P_filt[t1d_alkanani_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(t1d_alkanani_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         t1d_alkanani_P_filt <- t1d_alkanani_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["t1d_alkanani"]] <- t1d_alkanani_P_filt

     table2plot <- t1d_alkanani_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["t1d_alkanani"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["t1d_alkanani"]]
```


### t1d_mejialeon
```{r t1d_mejialeon_heatmap_filt, cache=TRUE}
     t1d_mejialeon_P_filt <- filt_results[["t1d_mejialeon"]]$adjP_table
     t1d_mejialeon_P_filt[t1d_mejialeon_P_filt >= 0.05] <- 1
     t1d_mejialeon_P_filt[t1d_mejialeon_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(t1d_mejialeon_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         t1d_mejialeon_P_filt <- t1d_mejialeon_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["t1d_mejialeon"]] <- t1d_mejialeon_P_filt

     table2plot <- t1d_mejialeon_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["t1d_mejialeon"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["t1d_mejialeon"]]
```


### wood_plastic_kesy
```{r wood_plastic_kesy_heatmap_filt, cache=TRUE}
     wood_plastic_kesy_P_filt <- filt_results[["wood_plastic_kesy"]]$adjP_table
     wood_plastic_kesy_P_filt[wood_plastic_kesy_P_filt >= 0.05] <- 1
     wood_plastic_kesy_P_filt[wood_plastic_kesy_P_filt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(wood_plastic_kesy_P_filt)) >= 8)
     if(length(features2remove) > 0) {
         wood_plastic_kesy_P_filt <- wood_plastic_kesy_P_filt[-features2remove, ]
      }
     all_P_tables_filt[["wood_plastic_kesy"]] <- wood_plastic_kesy_P_filt

     table2plot <- wood_plastic_kesy_P_filt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_filt[["wood_plastic_kesy"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_filt[["wood_plastic_kesy"]]
```


## Unfiltered data {.tabset}


### ArcticFireSoils
```{r ArcticFireSoils_heatmap_unfilt, cache=TRUE}
     ArcticFireSoils_P_unfilt <- unfilt_results[["ArcticFireSoils"]]$adjP_table
     ArcticFireSoils_P_unfilt[ArcticFireSoils_P_unfilt >= 0.05] <- 1
     ArcticFireSoils_P_unfilt[ArcticFireSoils_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(ArcticFireSoils_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         ArcticFireSoils_P_unfilt <- ArcticFireSoils_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["ArcticFireSoils"]] <- ArcticFireSoils_P_unfilt

     table2plot <- ArcticFireSoils_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["ArcticFireSoils"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["ArcticFireSoils"]]
```


### ArcticFreshwaters
```{r ArcticFreshwaters_heatmap_unfilt, cache=TRUE}
     ArcticFreshwaters_P_unfilt <- unfilt_results[["ArcticFreshwaters"]]$adjP_table
     ArcticFreshwaters_P_unfilt[ArcticFreshwaters_P_unfilt >= 0.05] <- 1
     ArcticFreshwaters_P_unfilt[ArcticFreshwaters_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(ArcticFreshwaters_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         ArcticFreshwaters_P_unfilt <- ArcticFreshwaters_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["ArcticFreshwaters"]] <- ArcticFreshwaters_P_unfilt

     table2plot <- ArcticFreshwaters_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["ArcticFreshwaters"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["ArcticFreshwaters"]]
```


### ArcticTransects
```{r ArcticTransects_heatmap_unfilt, cache=TRUE}
     ArcticTransects_P_unfilt <- unfilt_results[["ArcticTransects"]]$adjP_table
     ArcticTransects_P_unfilt[ArcticTransects_P_unfilt >= 0.05] <- 1
     ArcticTransects_P_unfilt[ArcticTransects_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(ArcticTransects_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         ArcticTransects_P_unfilt <- ArcticTransects_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["ArcticTransects"]] <- ArcticTransects_P_unfilt

     table2plot <- ArcticTransects_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["ArcticTransects"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["ArcticTransects"]]
```


### art_scher
```{r art_scher_heatmap_unfilt, cache=TRUE}
     art_scher_P_unfilt <- unfilt_results[["art_scher"]]$adjP_table
     art_scher_P_unfilt[art_scher_P_unfilt >= 0.05] <- 1
     art_scher_P_unfilt[art_scher_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(art_scher_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         art_scher_P_unfilt <- art_scher_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["art_scher"]] <- art_scher_P_unfilt

     table2plot <- art_scher_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["art_scher"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["art_scher"]]
```


### asd_son
```{r asd_son_heatmap_unfilt, cache=TRUE}
     asd_son_P_unfilt <- unfilt_results[["asd_son"]]$adjP_table
     asd_son_P_unfilt[asd_son_P_unfilt >= 0.05] <- 1
     asd_son_P_unfilt[asd_son_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(asd_son_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         asd_son_P_unfilt <- asd_son_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["asd_son"]] <- asd_son_P_unfilt

     table2plot <- asd_son_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["asd_son"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["asd_son"]]
```


### BISCUIT
```{r BISCUIT_heatmap_unfilt, cache=TRUE}
     BISCUIT_P_unfilt <- unfilt_results[["BISCUIT"]]$adjP_table
     BISCUIT_P_unfilt[BISCUIT_P_unfilt >= 0.05] <- 1
     BISCUIT_P_unfilt[BISCUIT_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(BISCUIT_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         BISCUIT_P_unfilt <- BISCUIT_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["BISCUIT"]] <- BISCUIT_P_unfilt

     table2plot <- BISCUIT_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["BISCUIT"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["BISCUIT"]]
```


### Blueberry
```{r Blueberry_heatmap_unfilt, cache=TRUE}
     Blueberry_P_unfilt <- unfilt_results[["Blueberry"]]$adjP_table
     Blueberry_P_unfilt[Blueberry_P_unfilt >= 0.05] <- 1
     Blueberry_P_unfilt[Blueberry_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(Blueberry_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         Blueberry_P_unfilt <- Blueberry_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["Blueberry"]] <- Blueberry_P_unfilt

     table2plot <- Blueberry_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["Blueberry"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["Blueberry"]]
```


### cdi_schubert
```{r cdi_schubert_heatmap_unfilt, cache=TRUE}
     cdi_schubert_P_unfilt <- unfilt_results[["cdi_schubert"]]$adjP_table
     cdi_schubert_P_unfilt[cdi_schubert_P_unfilt >= 0.05] <- 1
     cdi_schubert_P_unfilt[cdi_schubert_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(cdi_schubert_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         cdi_schubert_P_unfilt <- cdi_schubert_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["cdi_schubert"]] <- cdi_schubert_P_unfilt

     table2plot <- cdi_schubert_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["cdi_schubert"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["cdi_schubert"]]
```


### cdi_vincent
```{r cdi_vincent_heatmap_unfilt, cache=TRUE}
     cdi_vincent_P_unfilt <- unfilt_results[["cdi_vincent"]]$adjP_table
     cdi_vincent_P_unfilt[cdi_vincent_P_unfilt >= 0.05] <- 1
     cdi_vincent_P_unfilt[cdi_vincent_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(cdi_vincent_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         cdi_vincent_P_unfilt <- cdi_vincent_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["cdi_vincent"]] <- cdi_vincent_P_unfilt

     table2plot <- cdi_vincent_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["cdi_vincent"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["cdi_vincent"]]
```


### Chemerin
```{r Chemerin_heatmap_unfilt, cache=TRUE}
     Chemerin_P_unfilt <- unfilt_results[["Chemerin"]]$adjP_table
     Chemerin_P_unfilt[Chemerin_P_unfilt >= 0.05] <- 1
     Chemerin_P_unfilt[Chemerin_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(Chemerin_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         Chemerin_P_unfilt <- Chemerin_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["Chemerin"]] <- Chemerin_P_unfilt

     table2plot <- Chemerin_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["Chemerin"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["Chemerin"]]
```


### crc_baxter
```{r crc_baxter_heatmap_unfilt, cache=TRUE}
     crc_baxter_P_unfilt <- unfilt_results[["crc_baxter"]]$adjP_table
     crc_baxter_P_unfilt[crc_baxter_P_unfilt >= 0.05] <- 1
     crc_baxter_P_unfilt[crc_baxter_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(crc_baxter_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         crc_baxter_P_unfilt <- crc_baxter_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["crc_baxter"]] <- crc_baxter_P_unfilt

     table2plot <- crc_baxter_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["crc_baxter"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["crc_baxter"]]
```


### crc_zeller
```{r crc_zeller_heatmap_unfilt, cache=TRUE}
     crc_zeller_P_unfilt <- unfilt_results[["crc_zeller"]]$adjP_table
     crc_zeller_P_unfilt[crc_zeller_P_unfilt >= 0.05] <- 1
     crc_zeller_P_unfilt[crc_zeller_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(crc_zeller_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         crc_zeller_P_unfilt <- crc_zeller_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["crc_zeller"]] <- crc_zeller_P_unfilt

     table2plot <- crc_zeller_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["crc_zeller"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["crc_zeller"]]
```


### edd_singh
```{r edd_singh_heatmap_unfilt, cache=TRUE}
     edd_singh_P_unfilt <- unfilt_results[["edd_singh"]]$adjP_table
     edd_singh_P_unfilt[edd_singh_P_unfilt >= 0.05] <- 1
     edd_singh_P_unfilt[edd_singh_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(edd_singh_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         edd_singh_P_unfilt <- edd_singh_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["edd_singh"]] <- edd_singh_P_unfilt

     table2plot <- edd_singh_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["edd_singh"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["edd_singh"]]
```


### Exercise
```{r Exercise_heatmap_unfilt, cache=TRUE}
     Exercise_P_unfilt <- unfilt_results[["Exercise"]]$adjP_table
     Exercise_P_unfilt[Exercise_P_unfilt >= 0.05] <- 1
     Exercise_P_unfilt[Exercise_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(Exercise_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         Exercise_P_unfilt <- Exercise_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["Exercise"]] <- Exercise_P_unfilt

     table2plot <- Exercise_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["Exercise"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["Exercise"]]
```


### glass_plastic_oberbeckmann
```{r glass_plastic_oberbeckmann_heatmap_unfilt, cache=TRUE}
     glass_plastic_oberbeckmann_P_unfilt <- unfilt_results[["glass_plastic_oberbeckmann"]]$adjP_table
     glass_plastic_oberbeckmann_P_unfilt[glass_plastic_oberbeckmann_P_unfilt >= 0.05] <- 1
     glass_plastic_oberbeckmann_P_unfilt[glass_plastic_oberbeckmann_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(glass_plastic_oberbeckmann_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         glass_plastic_oberbeckmann_P_unfilt <- glass_plastic_oberbeckmann_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["glass_plastic_oberbeckmann"]] <- glass_plastic_oberbeckmann_P_unfilt

     table2plot <- glass_plastic_oberbeckmann_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["glass_plastic_oberbeckmann"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["glass_plastic_oberbeckmann"]]
```


### GWMC_ASIA_NA
```{r GWMC_ASIA_NA_heatmap_unfilt, cache=TRUE}
     GWMC_ASIA_NA_P_unfilt <- unfilt_results[["GWMC_ASIA_NA"]]$adjP_table
     GWMC_ASIA_NA_P_unfilt[GWMC_ASIA_NA_P_unfilt >= 0.05] <- 1
     GWMC_ASIA_NA_P_unfilt[GWMC_ASIA_NA_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(GWMC_ASIA_NA_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         GWMC_ASIA_NA_P_unfilt <- GWMC_ASIA_NA_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["GWMC_ASIA_NA"]] <- GWMC_ASIA_NA_P_unfilt

     table2plot <- GWMC_ASIA_NA_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["GWMC_ASIA_NA"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["GWMC_ASIA_NA"]]
```


### GWMC_HOT_COLD
```{r GWMC_HOT_COLD_heatmap_unfilt, cache=TRUE}
     GWMC_HOT_COLD_P_unfilt <- unfilt_results[["GWMC_HOT_COLD"]]$adjP_table
     GWMC_HOT_COLD_P_unfilt[GWMC_HOT_COLD_P_unfilt >= 0.05] <- 1
     GWMC_HOT_COLD_P_unfilt[GWMC_HOT_COLD_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(GWMC_HOT_COLD_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         GWMC_HOT_COLD_P_unfilt <- GWMC_HOT_COLD_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["GWMC_HOT_COLD"]] <- GWMC_HOT_COLD_P_unfilt

     table2plot <- GWMC_HOT_COLD_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["GWMC_HOT_COLD"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["GWMC_HOT_COLD"]]
```


### hiv_dinh
```{r hiv_dinh_heatmap_unfilt, cache=TRUE}
     hiv_dinh_P_unfilt <- unfilt_results[["hiv_dinh"]]$adjP_table
     hiv_dinh_P_unfilt[hiv_dinh_P_unfilt >= 0.05] <- 1
     hiv_dinh_P_unfilt[hiv_dinh_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(hiv_dinh_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         hiv_dinh_P_unfilt <- hiv_dinh_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["hiv_dinh"]] <- hiv_dinh_P_unfilt

     table2plot <- hiv_dinh_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["hiv_dinh"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["hiv_dinh"]]
```


### hiv_lozupone
```{r hiv_lozupone_heatmap_unfilt, cache=TRUE}
     hiv_lozupone_P_unfilt <- unfilt_results[["hiv_lozupone"]]$adjP_table
     hiv_lozupone_P_unfilt[hiv_lozupone_P_unfilt >= 0.05] <- 1
     hiv_lozupone_P_unfilt[hiv_lozupone_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(hiv_lozupone_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         hiv_lozupone_P_unfilt <- hiv_lozupone_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["hiv_lozupone"]] <- hiv_lozupone_P_unfilt

     table2plot <- hiv_lozupone_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["hiv_lozupone"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["hiv_lozupone"]]
```


### hiv_noguerajulian
```{r hiv_noguerajulian_heatmap_unfilt, cache=TRUE}
     hiv_noguerajulian_P_unfilt <- unfilt_results[["hiv_noguerajulian"]]$adjP_table
     hiv_noguerajulian_P_unfilt[hiv_noguerajulian_P_unfilt >= 0.05] <- 1
     hiv_noguerajulian_P_unfilt[hiv_noguerajulian_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(hiv_noguerajulian_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         hiv_noguerajulian_P_unfilt <- hiv_noguerajulian_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["hiv_noguerajulian"]] <- hiv_noguerajulian_P_unfilt

     table2plot <- hiv_noguerajulian_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["hiv_noguerajulian"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["hiv_noguerajulian"]]
```


### ibd_gevers
```{r ibd_gevers_heatmap_unfilt, cache=TRUE}
     ibd_gevers_P_unfilt <- unfilt_results[["ibd_gevers"]]$adjP_table
     ibd_gevers_P_unfilt[ibd_gevers_P_unfilt >= 0.05] <- 1
     ibd_gevers_P_unfilt[ibd_gevers_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(ibd_gevers_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         ibd_gevers_P_unfilt <- ibd_gevers_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["ibd_gevers"]] <- ibd_gevers_P_unfilt

     table2plot <- ibd_gevers_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["ibd_gevers"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["ibd_gevers"]]
```


### ibd_papa
```{r ibd_papa_heatmap_unfilt, cache=TRUE}
     ibd_papa_P_unfilt <- unfilt_results[["ibd_papa"]]$adjP_table
     ibd_papa_P_unfilt[ibd_papa_P_unfilt >= 0.05] <- 1
     ibd_papa_P_unfilt[ibd_papa_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(ibd_papa_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         ibd_papa_P_unfilt <- ibd_papa_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["ibd_papa"]] <- ibd_papa_P_unfilt

     table2plot <- ibd_papa_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["ibd_papa"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["ibd_papa"]]
```


### Ji_WTP_DS
```{r Ji_WTP_DS_heatmap_unfilt, cache=TRUE}
     Ji_WTP_DS_P_unfilt <- unfilt_results[["Ji_WTP_DS"]]$adjP_table
     Ji_WTP_DS_P_unfilt[Ji_WTP_DS_P_unfilt >= 0.05] <- 1
     Ji_WTP_DS_P_unfilt[Ji_WTP_DS_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(Ji_WTP_DS_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         Ji_WTP_DS_P_unfilt <- Ji_WTP_DS_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["Ji_WTP_DS"]] <- Ji_WTP_DS_P_unfilt

     table2plot <- Ji_WTP_DS_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["Ji_WTP_DS"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["Ji_WTP_DS"]]
```


### MALL
```{r MALL_heatmap_unfilt, cache=TRUE}
     MALL_P_unfilt <- unfilt_results[["MALL"]]$adjP_table
     MALL_P_unfilt[MALL_P_unfilt >= 0.05] <- 1
     MALL_P_unfilt[MALL_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(MALL_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         MALL_P_unfilt <- MALL_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["MALL"]] <- MALL_P_unfilt

     table2plot <- MALL_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["MALL"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["MALL"]]
```


### ob_goodrich
```{r ob_goodrich_heatmap_unfilt, cache=TRUE}
     ob_goodrich_P_unfilt <- unfilt_results[["ob_goodrich"]]$adjP_table
     ob_goodrich_P_unfilt[ob_goodrich_P_unfilt >= 0.05] <- 1
     ob_goodrich_P_unfilt[ob_goodrich_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(ob_goodrich_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         ob_goodrich_P_unfilt <- ob_goodrich_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["ob_goodrich"]] <- ob_goodrich_P_unfilt

     table2plot <- ob_goodrich_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["ob_goodrich"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["ob_goodrich"]]
```


### ob_ross
```{r ob_ross_heatmap_unfilt, cache=TRUE}
     ob_ross_P_unfilt <- unfilt_results[["ob_ross"]]$adjP_table
     ob_ross_P_unfilt[ob_ross_P_unfilt >= 0.05] <- 1
     ob_ross_P_unfilt[ob_ross_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(ob_ross_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         ob_ross_P_unfilt <- ob_ross_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["ob_ross"]] <- ob_ross_P_unfilt

     table2plot <- ob_ross_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["ob_ross"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["ob_ross"]]
```


### ob_turnbaugh
```{r ob_turnbaugh_heatmap_unfilt, cache=TRUE}
     ob_turnbaugh_P_unfilt <- unfilt_results[["ob_turnbaugh"]]$adjP_table
     ob_turnbaugh_P_unfilt[ob_turnbaugh_P_unfilt >= 0.05] <- 1
     ob_turnbaugh_P_unfilt[ob_turnbaugh_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(ob_turnbaugh_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         ob_turnbaugh_P_unfilt <- ob_turnbaugh_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["ob_turnbaugh"]] <- ob_turnbaugh_P_unfilt

     table2plot <- ob_turnbaugh_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["ob_turnbaugh"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["ob_turnbaugh"]]
```


### ob_zhu
```{r ob_zhu_heatmap_unfilt, cache=TRUE}
     ob_zhu_P_unfilt <- unfilt_results[["ob_zhu"]]$adjP_table
     ob_zhu_P_unfilt[ob_zhu_P_unfilt >= 0.05] <- 1
     ob_zhu_P_unfilt[ob_zhu_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(ob_zhu_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         ob_zhu_P_unfilt <- ob_zhu_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["ob_zhu"]] <- ob_zhu_P_unfilt

     table2plot <- ob_zhu_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["ob_zhu"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["ob_zhu"]]
```


### Office
```{r Office_heatmap_unfilt, cache=TRUE}
     Office_P_unfilt <- unfilt_results[["Office"]]$adjP_table
     Office_P_unfilt[Office_P_unfilt >= 0.05] <- 1
     Office_P_unfilt[Office_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(Office_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         Office_P_unfilt <- Office_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["Office"]] <- Office_P_unfilt

     table2plot <- Office_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["Office"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["Office"]]
```


### par_scheperjans
```{r par_scheperjans_heatmap_unfilt, cache=TRUE}
     par_scheperjans_P_unfilt <- unfilt_results[["par_scheperjans"]]$adjP_table
     par_scheperjans_P_unfilt[par_scheperjans_P_unfilt >= 0.05] <- 1
     par_scheperjans_P_unfilt[par_scheperjans_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(par_scheperjans_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         par_scheperjans_P_unfilt <- par_scheperjans_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["par_scheperjans"]] <- par_scheperjans_P_unfilt

     table2plot <- par_scheperjans_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["par_scheperjans"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["par_scheperjans"]]
```


### sed_plastic_hoellein
```{r sed_plastic_hoellein_heatmap_unfilt, cache=TRUE}
     sed_plastic_hoellein_P_unfilt <- unfilt_results[["sed_plastic_hoellein"]]$adjP_table
     sed_plastic_hoellein_P_unfilt[sed_plastic_hoellein_P_unfilt >= 0.05] <- 1
     sed_plastic_hoellein_P_unfilt[sed_plastic_hoellein_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(sed_plastic_hoellein_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         sed_plastic_hoellein_P_unfilt <- sed_plastic_hoellein_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["sed_plastic_hoellein"]] <- sed_plastic_hoellein_P_unfilt

     table2plot <- sed_plastic_hoellein_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["sed_plastic_hoellein"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["sed_plastic_hoellein"]]
```


### sed_plastic_rosato
```{r sed_plastic_rosato_heatmap_unfilt, cache=TRUE}
     sed_plastic_rosato_P_unfilt <- unfilt_results[["sed_plastic_rosato"]]$adjP_table
     sed_plastic_rosato_P_unfilt[sed_plastic_rosato_P_unfilt >= 0.05] <- 1
     sed_plastic_rosato_P_unfilt[sed_plastic_rosato_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(sed_plastic_rosato_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         sed_plastic_rosato_P_unfilt <- sed_plastic_rosato_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["sed_plastic_rosato"]] <- sed_plastic_rosato_P_unfilt

     table2plot <- sed_plastic_rosato_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["sed_plastic_rosato"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["sed_plastic_rosato"]]
```


### seston_plastic_mccormick
```{r seston_plastic_mccormick_heatmap_unfilt, cache=TRUE}
     seston_plastic_mccormick_P_unfilt <- unfilt_results[["seston_plastic_mccormick"]]$adjP_table
     seston_plastic_mccormick_P_unfilt[seston_plastic_mccormick_P_unfilt >= 0.05] <- 1
     seston_plastic_mccormick_P_unfilt[seston_plastic_mccormick_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(seston_plastic_mccormick_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         seston_plastic_mccormick_P_unfilt <- seston_plastic_mccormick_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["seston_plastic_mccormick"]] <- seston_plastic_mccormick_P_unfilt

     table2plot <- seston_plastic_mccormick_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["seston_plastic_mccormick"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["seston_plastic_mccormick"]]
```


### sw_plastic_frere
```{r sw_plastic_frere_heatmap_unfilt, cache=TRUE}
     sw_plastic_frere_P_unfilt <- unfilt_results[["sw_plastic_frere"]]$adjP_table
     sw_plastic_frere_P_unfilt[sw_plastic_frere_P_unfilt >= 0.05] <- 1
     sw_plastic_frere_P_unfilt[sw_plastic_frere_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(sw_plastic_frere_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         sw_plastic_frere_P_unfilt <- sw_plastic_frere_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["sw_plastic_frere"]] <- sw_plastic_frere_P_unfilt

     table2plot <- sw_plastic_frere_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["sw_plastic_frere"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["sw_plastic_frere"]]
```


### sw_sed_detender
```{r sw_sed_detender_heatmap_unfilt, cache=TRUE}
     sw_sed_detender_P_unfilt <- unfilt_results[["sw_sed_detender"]]$adjP_table
     sw_sed_detender_P_unfilt[sw_sed_detender_P_unfilt >= 0.05] <- 1
     sw_sed_detender_P_unfilt[sw_sed_detender_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(sw_sed_detender_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         sw_sed_detender_P_unfilt <- sw_sed_detender_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["sw_sed_detender"]] <- sw_sed_detender_P_unfilt

     table2plot <- sw_sed_detender_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["sw_sed_detender"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["sw_sed_detender"]]
```


### t1d_alkanani
```{r t1d_alkanani_heatmap_unfilt, cache=TRUE}
     t1d_alkanani_P_unfilt <- unfilt_results[["t1d_alkanani"]]$adjP_table
     t1d_alkanani_P_unfilt[t1d_alkanani_P_unfilt >= 0.05] <- 1
     t1d_alkanani_P_unfilt[t1d_alkanani_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(t1d_alkanani_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         t1d_alkanani_P_unfilt <- t1d_alkanani_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["t1d_alkanani"]] <- t1d_alkanani_P_unfilt

     table2plot <- t1d_alkanani_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["t1d_alkanani"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["t1d_alkanani"]]
```


### t1d_mejialeon
```{r t1d_mejialeon_heatmap_unfilt, cache=TRUE}
     t1d_mejialeon_P_unfilt <- unfilt_results[["t1d_mejialeon"]]$adjP_table
     t1d_mejialeon_P_unfilt[t1d_mejialeon_P_unfilt >= 0.05] <- 1
     t1d_mejialeon_P_unfilt[t1d_mejialeon_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(t1d_mejialeon_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         t1d_mejialeon_P_unfilt <- t1d_mejialeon_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["t1d_mejialeon"]] <- t1d_mejialeon_P_unfilt

     table2plot <- t1d_mejialeon_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["t1d_mejialeon"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["t1d_mejialeon"]]
```


### wood_plastic_kesy
```{r wood_plastic_kesy_heatmap_unfilt, cache=TRUE}
     wood_plastic_kesy_P_unfilt <- unfilt_results[["wood_plastic_kesy"]]$adjP_table
     wood_plastic_kesy_P_unfilt[wood_plastic_kesy_P_unfilt >= 0.05] <- 1
     wood_plastic_kesy_P_unfilt[wood_plastic_kesy_P_unfilt < 0.05] <- 0
     # Remove features that are all NA in at least 8 columns (which corresponds to ASV only in the rarified data)
     features2remove <- which(rowSums(is.na(wood_plastic_kesy_P_unfilt)) >= 8)
     if(length(features2remove) > 0) {
         wood_plastic_kesy_P_unfilt <- wood_plastic_kesy_P_unfilt[-features2remove, ]
      }
     all_P_tables_unfilt[["wood_plastic_kesy"]] <- wood_plastic_kesy_P_unfilt

     table2plot <- wood_plastic_kesy_P_unfilt
     if(nrow(table2plot) > 10000) {
         table2plot <- table2plot[sample(rownames(table2plot), 10000), ]
     }

     heatmaps_unfilt[["wood_plastic_kesy"]] <- pheatmap(t(table2plot),
                                                  color=c("cornflowerblue", "black"),
                                                  clustering_distance_cols = "binary",
                                                  clustering_distance_rows = "binary",
                                                  clustering_method = "complete",
                                                  show_colnames = FALSE,
                                                  legend=FALSE)


     heatmaps_unfilt[["wood_plastic_kesy"]]
```


## Combined {.tabset}

Then made huge table of all ASV significance across all datasets and plotted as a heatmap. NOTE THAT THIS HEATMAP IS ACTUALLY BASED ON A RANDOM SUB-SAMPLING OF 3,000 RANDOM FEATURES. I kept getting this error when trying to plot more features: "Error: node stack overflow Error during wrapup: node stack overflow"

### Filtered data

```{r combined_heatmap_filt, fig.height=6, fig.width=12, cache=TRUE}
# Get combined table of binary significance patterns.

split_vec_filt <- c()
for(dataset in names(all_P_tables_filt)) {
  split_vec_filt <- c(split_vec_filt, rep(dataset, length(heatmaps_filt[[dataset]]$tree_col$labels)))
}

combined_sig_table_filt <- do.call("rbind", all_P_tables_filt)

set.seed(131)
random_row_i <- sample(1:nrow(combined_sig_table_filt), size=3000, replace=FALSE)

combined_sig_table_filt_subset <- as.matrix(combined_sig_table_filt[random_row_i, ])

col_rnorm = colorRamp2(c(0, 1), c("cornflowerblue", "black"))

heatmaps_filt[["combined"]] <- Heatmap(matrix=t(combined_sig_table_filt_subset),
                                  col=col_rnorm,
                                  name="Combined Heatmap",
                                  show_column_dend = FALSE,
                                  show_column_names = FALSE,
                                  #show_row_dend=FALSE,
                                  #show_row_names=FALSE,
                                  column_split=split_vec_filt[random_row_i],
                                  #column_names_rot = 45,
                                  #row_title_rot=0,
                                  row_names_rot = 0,
                                  column_title_rot=90,
                                  #row_gap=unit(3, "mm"),
                                  clustering_distance_rows="binary",
                                  clustering_distance_columns="binary",
                                  show_heatmap_legend=FALSE)

heatmaps_filt[["combined"]]

```

### Unfiltered data

```{r combined_heatmap_unfilt, fig.height=6, fig.width=12, cache=TRUE}
# Get combined table of binary significance patterns.

all_P_tables_unfilt_col_count <- sapply(all_P_tables_unfilt, ncol)
all_P_tables_unfilt_all_12 <- all_P_tables_unfilt[which(all_P_tables_unfilt_col_count == 12)]
combined_sig_table_unfilt <- do.call("rbind", all_P_tables_unfilt_all_12)

split_vec_unfilt <- c()
for(dataset in names(all_P_tables_unfilt_all_12)) {
  split_vec_unfilt <- c(split_vec_unfilt, rep(dataset, nrow(all_P_tables_unfilt_all_12[[dataset]])))
}

set.seed(131)
random_row_i <- sample(1:nrow(combined_sig_table_unfilt), size=3000, replace=FALSE)

combined_sig_table_unfilt_subset <- as.matrix(combined_sig_table_unfilt[random_row_i, ])

col_rnorm = colorRamp2(c(0, 1), c("cornflowerblue", "black"))

heatmaps_unfilt[["combined"]] <- Heatmap(matrix=t(combined_sig_table_unfilt_subset),
                                  col=col_rnorm,
                                  name="Combined Heatmap",
                                  show_column_dend = FALSE,
                                  show_column_names = FALSE,
                                  #show_row_dend=FALSE,
                                  #show_row_names=FALSE,
                                  column_split=split_vec_unfilt[random_row_i],
                                  #column_names_rot = 45,
                                  #row_title_rot=0,
                                  row_names_rot = 0,
                                  column_title_rot=90,
                                  #row_gap=unit(3, "mm"),
                                  clustering_distance_rows="binary",
                                  clustering_distance_columns="binary",
                                  show_heatmap_legend=FALSE)

heatmaps_unfilt[["combined"]]

```


# Tool PCoAs and distance matrices {.tabset}

## Filtered data

```{r overlap_percent_filt, fig.height=6, fig.width=12, cache=TRUE}

first_marker = TRUE

for(dataset in names(all_P_tables_filt)) {

  swapped_values <- all_P_tables_filt[[dataset]]
  swapped_values[swapped_values == 0] <- 2
  swapped_values[swapped_values == 1] <- 0
  
  if(first_marker) {
    dataset_binary_dists <- dist(t(swapped_values), method = "binary")
    first_marker <- FALSE
  } else {
    dataset_binary_dists <- dataset_binary_dists + dist(t(swapped_values), method = "binary")
  }
}

dataset_binary_dists <- dataset_binary_dists / length(all_P_tables_filt)


print(dataset_binary_dists)

filt_pcoa <- pcoa(dataset_binary_dists, correction="none", rn=NULL)

eig_percent <- round(filt_pcoa$values$Relative_eig * 100, 3)

xlab_set <- paste("Axis 1 (", as.character(eig_percent[1]), "%)", sep="")
ylab_set <- paste("Axis 2 (", as.character(eig_percent[2]), "%)", sep="")

plot(filt_pcoa$vectors[, "Axis.1"], filt_pcoa$vectors[, "Axis.2"],
     col="white", xlab = xlab_set, ylab=ylab_set) 
text(filt_pcoa$vectors[, "Axis.1"], filt_pcoa$vectors[, "Axis.2"], labels = rownames(filt_pcoa$vectors))

```


## Unfiltered data

```{r overlap_percent_unfilt, fig.height=6, fig.width=12, cache=TRUE}

first_marker = TRUE

for(dataset in names(all_P_tables_unfilt_all_12)) {

  swapped_values <- all_P_tables_unfilt[[dataset]]
  swapped_values[swapped_values == 0] <- 2
  swapped_values[swapped_values == 1] <- 0
  
  if(first_marker) {
    dataset_binary_dists <- dist(t(swapped_values), method = "binary")
    first_marker <- FALSE
  } else {
    dataset_binary_dists <- dataset_binary_dists + dist(t(swapped_values), method = "binary")
  }
}

dataset_binary_dists <- dataset_binary_dists / length(all_P_tables_unfilt)


print(dataset_binary_dists)

filt_pcoa <- pcoa(dataset_binary_dists, correction="none", rn=NULL)

eig_percent <- round(filt_pcoa$values$Relative_eig * 100, 3)

xlab_set <- paste("Axis 1 (", as.character(eig_percent[1]), "%)", sep="")
ylab_set <- paste("Axis 2 (", as.character(eig_percent[2]), "%)", sep="")

plot(filt_pcoa$vectors[, "Axis.1"], filt_pcoa$vectors[, "Axis.2"],
     col="white", xlab = xlab_set, ylab=ylab_set) 
text(filt_pcoa$vectors[, "Axis.1"], filt_pcoa$vectors[, "Axis.2"], labels = rownames(filt_pcoa$vectors))

```


# Session info
R session information reported here for reproducibility.

```{r session_info}
sessionInfo()
```
